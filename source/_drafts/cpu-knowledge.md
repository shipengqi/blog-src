---
title: cpu-knowledge
tags:
---

## 平均负载
运行 `uptime` 命令，
输出的 `load average` 表示平均负载，三个数字分别表示过去 1 分钟，5 分钟，15 分钟的平均负载。

平均负载 是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程。

可运行状态 - R 状态 Running 或者 Runnable 
不可中断状态 - 处于内核态关键流程的进程，这些流程不可被打断

平均负载为 2 ：
在 2 个 CPU 的系统上，意味着 CPU 刚好全部被占用
在 4 个 CPU 的系统上，以为着有一半的 CPU 空闲。
在 1 个 CPU 的系统上，意味着有一半的进程抢不到 CPU

最理想的情况就是第一种，刚好等于 CPU 的个数

`cat /proc/cpuinfo` 查看 

## CPU 使用率
https://www.cnblogs.com/my_captain/p/12667016.html
## 进程和线程


## 什么是 CPU 上下文
Linux 是一个多任务操作系统，支持同时运行的任务远大于 CPU 的核数。系统在很短的时间内，将 CPU 轮流分配给这些
任务，使这些任务同时运行。

CPU 在运行任务之前，要知道任务从哪里加载，从哪里开始运行，也就是说需要系统先帮它设置好 CPU 寄存器和程序计数器。它们是 CPU 运行任务的依赖环境，
也叫做 CPU 上下文。

### 寄存器

寄存器是 CPU 内置的存储单元。寄存器主要用于存储从内存中读取的数据和 CPU 运算的中间结果。寄存器的读写速度比内存快的多，而且有些操作运算只能在
CPU 内部进行。

### 常用寄存器
以 AMD 为例：
通用寄存器：rax, rbx, rcx, rdx, rsi, rdi, rbp, rsp, r8, r9, r10, r11, r12, r13, r14, r15 寄存器。这1 6 个寄存器没有做特殊规定，程
序员和编译器可以自定义其用途

程序计数器（PC 寄存器，IP 寄存器）：rip 寄存器。用来存**放下一条即将执行的指令的地址**，决定了程序的执行流程；

段寄存器：fs 和 gs 寄存器。一般用它来实现线程本地存储（TLS）。



#### rsp 栈顶寄存器和 rbp 栈基址寄存器

这两个寄存器和函数调用栈有关，rsp 寄存器一般用来存放函数调用栈的栈顶地址，而 rbp 寄存器通常用来存放函数的栈帧起始地址

编译器一般使用这两个寄存器加一定偏移的方式来访问函数局部变量或函数参数

关于 CPU 缓存：https://coolshell.cn/articles/20793.html
## 上下文切换
CPU 上下文切换就是先把当前任务的 CPU 上下文保存起来，加载新任务的上下文到寄存器和程序计数器，然后从程序计数器
所指的位置开始执行新任务

这些上下文被保存在内核的内存中，当任务被重新调度时，再加载到寄存器中。从而保证任务原来的状态不受影响

为什么会影响性能？
每次上下文切换都需要几十纳秒到数微秒的时间，如果上下文切换非常多，就会导致 CPU 将大量时间浪费在寄存器，内核栈 虚拟内存
等资源的保存和恢复上，缩短了真正执行进程的时间。



### 内核空间和用户空间
### 系统调用
特权模式切换

### 进程上下文切换
### 什么时候会切换进程上下文
进程在被调度时，才会切换上下文，那么进程在什么时候才会被调度到 CPU 上运行呢？

1. 为了保证所有进程可以得到公平调度，CPU 时间片被划分为一段段的时间片，这些时间片再被轮流分配给各个进程。这样，当某个进程的时间片耗
尽了，就会被系统挂起，切换到其他正在等待CPU的进程运行。
2. 进程在系统资源不足(比如内存不足)时，需要等到资源满足后才可以运行，这个时候进程也会被挂起，并由系统调度其他进程运行。
3. 当进程通过随眠函数 sleep 这样的方法将自己主动挂起时，自然也会重新调度。
4. 当有优先级更高的进程运行时，为了保证高优先级进程的运行，当前进程会被挂起，由高优先级的进程来运行。
5. 当发生硬件中断时，CPU 上的进程会被中断挂起，转而执行内核中中断服务程序。
### 线程上下文切换
### 中断上下文切换

### 如何查看系统上下文切换的情况

### 自愿上下文切换 和 非自愿上下文切换
自愿上下文切换是指 进程无法获取所需要的自愿，导致上下文切换。

非自愿上下文切换是指进程的时间片已到等原因，被系统强制调度，导致的上下文切换。

自愿上下文变多了，说明进程都在等待自愿，有可能发生了 I/O 等问题

非自愿上下文变多了，说明进程都在被强制调度，在争抢 CPU，说明 CPU 成了瓶颈。

中断次数变多了，说明 CPU 被中断处理程序占用，通过 `/proc/interrupts` 文件分析中断类型。
## 常用的 linux 性能调试的工具

## 时间片的概念
时间片即 CPU 分配给各个程序的时间，每个线程被分配一个时间段，称作它的时间片，即该进程允许运行的时间，使各个程序
从表面上看是同时进行的。如果在时间片结束时进程还在运行，则CPU将被剥夺并分配给另一个进程。如果进程在时间片结
束前阻塞或结束，则CPU当即进行切换。而不会造成 CPU 资源浪费。在宏观上：我们可以同时打开多个应用程序，每个程序并
行不悖，同时运行。但在微观上：由于只有一个 CPU，一次只能处理程序要求的一部分，如何处理公平，一种方法就是引入
时间片，每个程序轮流执行。
