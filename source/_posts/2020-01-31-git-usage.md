---
title: Git 的一些使用技巧
date: 2020-01-31 17:29:19
categories: ["乱七八糟"]
---

Git 是一个非常强大的版本控制工具，是程序员必须要掌握的技能。

这里记录常用的命令技巧和碰到的一些问题。

<!-- more -->

首先应该了解 Git 里面的几个概念。

![](/images/git-use/git-use.png)

- Workspace：工作区
- Index/Stage：暂存区（使用 `git add` 命令将工作区的改动添加到暂存区）
- Repository：本地仓库（使用 `git commit` 命令将暂存区的改动提交到本地仓库）
- HEAD：指向本地仓库的当前版本，上一个版本就是 `HEAD^`，上上一个版本就是 `HEAD^^`，往上 10 个版本，可以
写成 `HEAD~10`。
- Remote：远程仓库


## 克隆仓库：
``` bash
git clone git@github.com:shipengqi/shipengqi.github.io.git <target dir> -b <branch>
```

将 `shipengqi.github.io.git` 克隆到 `target dir` 指定的文件夹（默认是远程仓库的名字），并切换到指定
分支 `branch`（默认是 master 分支）。

## 未暂存的内容
### 把未暂存的内容添加到暂存区
``` bash
# 提交所有改动
git add -A

# 提交被修改 (modified) 和被删除 (deleted) 文件，不包括新文件 (new)
git add -u

# 提交新文件 (new) 和被修改 (modified) 文件，不包括被删除 (deleted) 文件
git add .

# 添加指定文件到暂存区
git add [file1] [file2] ...

# 添加指定目录到暂存区，包括子目录
git add [dir]

# 添加每个变化前，都会要求确认
# 对于同一个文件的多处变化，可以实现分次提交
git add -p
```

### 把未暂存的内容移动到一个新分支
```sh
git checkout -b new-branch
```

### 把未暂存的内容移动到另一个已存在的分支
```sh
git stash
git checkout my-branch
git stash pop
```

### 放弃未暂存的修改
```sh
git checkout <file-name>

# 放弃所有修改
git checkout .
```

## 暂存的内容
### 把暂存的内容添加到上一次的提交
```sh
git commit --amend
```

### 取消暂存的内容
添加到暂存区的文件，但是还没有提交，如果想要撤销暂存的文件，可以使用 `git reset HEAD <file1> <file2>...` 的方式取消暂存。

```sh
git reset HEAD file2
# 或者
# 同时删除工作区和暂存区中的文件
git rm [file1] [file2] ...

# 从暂存区删除文件, 但工作区不删除
git rm --cached [file]
```

这样 `file2` 文件又回到了之前已修改未暂存的状态。

## 编辑提交
### 修改提交信息
```sh
# 打开默认编辑器
git commit --amend --only

# 或者
git commit --amend --only -m 'xxxxxxx'
```
如果已经 push 了这次提交, 那么可以修改这次提交(commit)然后强推(force push), 但是不推荐。

### 修改提交里的用户名和邮箱
```sh
git commit --amend --author "New Authorname <work@example.com>"
```

### 撤销某一次提交
#### 修改已经提交到了当前分支，但是还没有 push 到远程仓库
```sh
git reset --hard HEAD^

# 回退到指定的版本
git reset --hard <commit id>

# 只撤销提交，但不改变代码
git reset HEAD^
git reset commit-id
```

#### 已经 push 到远程仓库的提交

已经 push 到远程仓库的提交，使用`git revert`，回滚到指定的历史版本,再 `git push` 更新远程仓库。
``` bash
# 回滚至某个 commit 版本
git revert commit-id
```

#### revert 与 reset 的区别:
- reset 是在正常的 commit 历史中,删除了指定的 commit，这时 HEAD 是向后移动了，而 revert 是在正常的 commit 历史中再 commit 一
次，HEAD 是一直向前的。
- 对于已经把代码已经 push 到远程仓库，reset 删除指定 commit 以后，`push` 可能导致一大堆冲突.但是 revert 不会。

## Stash
`stash` 和 `add` 的区别:
`git stash` 的作用是把工作区(必须是工作区中已经被 git 追踪到的文件)和暂存区中的内容暂时存到一个栈上。而且这个堆是和分支不
相关的。切换分支后，依然可以看到并使用。

`git add` 命令将修改添加到暂存区。

### 暂存工作目录下的所有改动
```sh
git stash
```

### 暂存所有改动，包括 untracked 的文件（新建的文件）
```sh
git stash -u
```

### 暂存指定文件
```sh
# 暂存某一个文件
git stash push working-directory-path/filename.ext

# 暂存多个文件
git stash push working-directory-path/filename1.ext working-directory-path/filename2.ext
```

### 暂存时记录消息
```sh
git stash save <message>

# 或
git stash push -m <message>
```

### 使用某个指定暂存
```sh
# 查看 stash 记录
git stash list

# apply 某个 stash
git stash apply "stash@{n}"
```

`n` 是 stash 在栈中的位置，最上层的 stash 会是 `0`。

### 使用最后一个 stash 的状态，并删除这个 stash
```sh
git stash pop
```

### 删除所有的 stash
```sh
git stash clear
```
### 仅从 stash 中拿出某个文件的修改
```sh
git checkout <stash@{n}> -- <file-path>
```

### 查看 commit 历史
``` bash
# 显示当前分支的版本历史
git log

# 显示 commit 历史，以及每次 commit 发生变更的文件
git log --stat

# 搜索提交历史，根据关键词
git log -S [keyword]

# 显示某个 commit 之后的所有变动，每个 commit 占据一行
git log [tag] HEAD --pretty=format:%s

# 显示某个 commit 之后的所有变动，其"提交说明"必须符合搜索条件
git log [tag] HEAD --grep feature

# 显示某个文件的版本历史，包括文件改名
git log --follow [file]
git whatchanged [file]

# 显示指定文件相关的每一次 diff
git log -p [file]

# 显示过去 5 次提交
git log -5 --pretty --oneline

# 显示所有提交过的用户，按提交次数排序
git shortlog -sn

# 显示指定文件是什么人在什么时间修改过
git blame [file]

#查看命令历史
git reflog
```

当你用 `git reset --hard HEAD^` 回退到上个版本时，再想恢复，就必须找到要恢复版本的 commit id。可以通过 `git reflog` 找到那次 commit。
回退前，用 `git log` 可以查看提交历史，以便确定要回退到哪个版本。
回退后，用 `git reflog` 查看命令历史，以便确定要回到未来的哪个版本。

### 比较差异
``` bash
# 显示暂存区和工作区的差异
git diff

# 显示暂存区和上一个 commit 的差异
git diff --cached [file]

# 显示工作区与当前分支最新 commit 之间的差异
git diff HEAD

# 显示两次提交之间的差异
git diff [first-branch]...[second-branch]
```

### 查看某次提交
``` bash
# 显示某次提交的元数据和内容变化
git show [commit]

# 显示某次提交发生变化的文件
git show --name-only [commit]

# 显示某次提交时，某个文件的内容
git show [commit]:[filename]
```

### 分支

``` bash
#切换分支
git checkout dev

#切换并新建一个分支
git checkout -b newBranch

#删除一个分支
git branch -d branch

# 列出所有本地分支
git branch

# 列出所有远程分支
git branch -r

# 列出所有本地分支和远程分支
git branch -a

# 删除远程分支
git push origin --delete [branch-name]
git branch -dr [remote/branch]

# 合并指定分支到当前分支
git merge [branch]

# 选择一个commit，合并进当前分支
git cherry-pick [commit]
```

### 同步远程仓库
``` bash
# 下载远程仓库的所有变动
git fetch

# 显示所有远程仓库
git remote -v

# 显示某个远程仓库的信息
git remote show [remote]

# 增加一个新的远程仓库，并命名
git remote add [shortname] [url]

# 取回远程仓库的变化，并与本地分支合并
git pull [remote] [branch]

# 上传本地指定分支到远程仓库
git push [remote] [branch]

# 强行推送当前分支到远程仓库，即使有冲突
git push [remote] --force

# 推送所有分支到远程仓库
git push [remote] --all
```


### 生成压缩包
``` bash
git archive
```

## 配置别名
``` bash
git config --global alias.st status
```
以后st就表示status，可以敲`git st`代替`git status`

## 错误处理

### 读取不到github上的分支
Please make sure you have the correct access rights and the repository exists.

一般可能是因为没有在github账号添加SSH key。
解决方法：
``` bash
#git设置account
git config --global user.name "yourname"
git config --global user.email“your@email.com"

#生成ssh key
ssh-keygen
#拷贝id_rsa.pub
cat id_rsa.pub
```

登录github，添加ssh key即可。

### remote error

``` bash
git push origin feature/es6
fatal: remote error:
  You can't push to git://github.houston.softwaregrp.net/he-chatops/hubot-enterprise-bot.git
  Use https://github.houston.softwaregrp.net/he-chatops/hubot-enterprise-bot.git

#解决
git remote rm origin
git remote add origin git@github.houston.softwaregrp.net:he-chatops/hubot-enterprise-bot.git
git push origin feature/es6
```

## 技巧
记录常用的技巧。

### 配置常用的命令别名
```bash
git config --global alias.st status
git config --global alias.br branch
git config --global alias.co checkout
git config --global alias.ci commit
```
原生的`git log`不太好用，一样可以配置：
```bash
git config --global alias.lg 'log --color --graph --pretty=format:"%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset" --abbrev-commit'
```
然后`git lg`就成了下面的样子：
![](/images/git-use/log.JPG)



### 怎么把主仓库的 commits 拉取到自己 fork 的仓库
如果一个项目多人维护，每个人都 fork 了主仓库，并修改，提交 PR，那么如果在你提交自己的修改之前，主仓库 merge 了别人的 PR，
你 fork 的仓库的 commit 就会落后于主仓库，例如会有类似 `This branch is 12 commit behind ITOM-Shared-Services:master.` 的提示。这个时候
直接提交你的代码，创建 PR，如果 merge 你的 PR，可能就会有冲突，怎么解决？

1. 切换在你本地的仓库
2. 添加 remote
```sh
git remote add itom git@github.houston.softwaregrp.net:ITOM-Shared-Services/cdf-service.git
```
上面的命令中 `itom` 是给这个 remote 命名，`git@github.houston.softwaregrp.net:ITOM-Shared-Services/cdf-service.git` 是 remote 的地址。

3. 验证 `git remote -v`
4. **在每次提交前执行 `git pull itom master`**，可以把主仓库的最新 commits 拉去到本地。
5. 提交代码
