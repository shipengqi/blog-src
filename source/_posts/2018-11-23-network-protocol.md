---
title: 精读 趣谈网络协议
date: 2018-11-23 14:27:12
categories: ["Protocol"]
tags: ["Http", "TcpIp"]
---

想成为技术牛人，先搞定网络协议。

<!-- more -->

## 为什么要学习网络协议？

计算机语言（C语言，Java 等）是人类和计算机沟通的协议，通过这种协议，计算机可以知道我们想让它做什么。但是这种协议计算机不能直接读懂，
对于计算机，它只认识 0 和 1，所以计算机语言还需要编译之后，计算机才会读懂。

协议三要素：
- 语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
- 语义，就是一段内容代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
- 顺序，就是先干啥，后干啥。例如，先加上某个值，再减去某个值。

计算机语言，能够教给一台计算机完成你的工作，但是，要想一大片机器互相协作、共同完成一件事，只教给一台机器做什么是不够的，你需要学会
给一大片机器做什么。这就需要**网络协议**。

## 网络分层的真实含义是什么？
复杂的程序都要分层。比如，复杂的电商还会分数据库层、缓存层、Compose 层、Controller 层和接入层，每一层专注做本层的事情。

程序是如何工作的？
![](../images/network-protocol/protocol-layers.jpg)

只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。

例如：TCP 在三次握手的时候，IP 层和MAC 层在做什么呢？当然是TCP 发送每一个消息，都会带着IP 层和MAC 层了。因为，TCP 每发送一个消息，IP 层和MAC 层的所有机制都
要运行一遍。而你只看到TCP 三次握手了，其实，IP 层和MAC 层为此也忙活好久了。

所以，对TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有IP 层和MAC 层，不然是发不出去的。

所谓的**二层设备、三层设备**，都是这些设备上跑的程序不同而已。一个HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包。这里面HTTP、TCP、IP、MAC 都有。什么叫二层设备呀，
就是只把MAC 头摘下来，看看到底是丢弃、转发，还是自己留着。那什么叫三层设备呢？就是把MAC头摘下来之后，再把IP 头摘下来，看看到底是丢弃、转发，还是自己留着。

## ifconfig：最熟悉又陌生的命令行
怎么查看IP 地址？
Windows 上是`ipconfig`，在Linux 上是`ifconfig`，`ip addr`。

**IP 地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。**大部分的网卡都会有一个IP 地址，当然，这不是必须的。

32 位的IP 地址就被分成了5 类：

![](../images/network-protocol/ipaddr.jpg)

![](../images/network-protocol/ipaddr-range.jpg)

C 类地址能包含的最大主机数量只有254 个，现在估计一个网吧都不够用。
B 类地址能包含的最大主机数量又太多了。6 万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。

### 无类型域间选路（CIDR）
CIDR，打破了原来设计的几类地址的做法，将`32`位的IP 地址一分为二，前面是网络号，后面是主机号。从哪里分呢？你如果注意观察的话可以看到，`10.100.122.2/24`，
这个IP 地址中有一个斜杠，斜杠后面有个数字`24`。这种地址表示形式，就是CIDR。后面`24`的意思是，`32`位中，前`24`位是网络号，后`8`位是主机号。

伴随着CIDR 存在的，一个是**广播地址**，`10.100.122.255`。如果发送这个地址，所有`10.100.122`网络里面的机器都可以收到。另一个是**子网掩码**，`255.255.255.0`。
将子网掩码和IP 地址进行`AND`计算，就可得到**网络号**。


### 公有IP 地址和私有IP 地址

在日常的工作中，几乎不用划分A 类、B 类或者C 类，所以时间长了，很多人就忘记了这个分类，而只记得CIDR。但是有一点还是要注意的，就是公有IP 地址和私有IP 地址。

![](../images/network-protocol/ipaddr-range.jpg)

表格最右列是私有IP 地址段。平时我们看到的数据中心里，办公室、家里或学校的IP 地址，一般都是私有IP 地址段。因为这些地址允许组织内部的IT 人员自己管理、自己分配，而
且可以重复。因此，你学校的某个私有IP 地址段和我学校的可以是一样的。

这就像每个小区有自己的楼编号和门牌号，你们小区可以叫6 栋，我们小区也叫6 栋，没有任何问题。但是一旦出了小区，就需要使用公有IP 地址。

`192.168.0.x`是最常用的私有IP 地址。一般你家里地上网设备不会超过256 个，所以`/24`基本就够了。有时候我们也能见到`/16 =`的CIDR，这两种是最常见的。
很明显`192.168.0`是网络号，整个网络里面的第一个地址`192.168.0.1`,往往就是你这个**私有网络的出口地址**。例如你家的路由器地址就是`192.168.0.1`。
`192.168.0.255`就是广播地址。一旦发送这个地址，整个`192.168.0`网络里面的所有机器都能收到。

### 一个容易“犯错”的CIDR
`16.158.165.91/22`这个CIDR。求一下这个网络的第一个地址、子网掩码和广播地址。

要是上来就写`16.158.165.1`，那就大错特错了。

`/22`不是`8`的整数倍，不好办，只能先变成二进制来看。`16.158`的部分不会动，它占了前`16`位。中间的`165`，变为二进制为`10100101` 。除了前面的`16`位，
还剩`6`位。所以，这`8`位中前`6`位是网络号，`16.158.<101001>`，而`<01>.91`是机器号。第一个地址是`16.158.<101001><00>.1`，即`16.158.164.1`。
子网掩码是`255.255.<111111><00>.0`，即`255.255.252.0`。广播地址为`16.158.<101001><11>.255`，即`16.158.167.255`。

**D 类是组播地址**。使用这一类地址，属于某个组的机器都能收到。这有点类似在公司里面大家都加入了一个邮件组。发送邮件，加入这个组的都能收到。

```bash
root@test:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
inet6 ::1/128 scope host
valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff
inet 10.100.122.2/24 brd 10.100.122.255 scope global eth0
valid_lft forever preferred_lft forever
inet6 fe80::f816:3eff:fec7:7975/64 scope link
valid_lft forever preferred_lft forever
```

上面的输出，IP 地址的后面有个`scope`，对于`eth0`这张网卡来讲，是`global`，说明这张网卡是可以对外的，可以接收来自各个地方的包。对于`lo`来讲，是`host`，说明这张网
卡仅仅可以供本机相互通信。

`lo`全称是`loopback`，又称环回接口，往往会被分配到`127.0.0.1`这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。这就是为什么你可以在浏览器
通过访问`127.0.0.1`这个地址来访问本地服务，而且一般在你本机的`host`文件，会有`127.0.0.1 localhost`，这是个映射关系，访问`localhost`相当于`127.0.0.1`。


### MAC 地址



