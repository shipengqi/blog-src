---
title: 精读 趣谈网络协议
date: 2018-11-23 14:27:12
categories: ["Protocol"]
tags: ["Http", "TcpIp"]
---

想成为技术牛人，先搞定网络协议。

<!-- more -->

## 为什么要学习网络协议？

计算机语言（C语言，Java 等）是人类和计算机沟通的协议，通过这种协议，计算机可以知道我们想让它做什么。但是这种协议计算机不能直接读懂，
对于计算机，它只认识 0 和 1，所以计算机语言还需要编译之后，计算机才会读懂。

协议三要素：
- 语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
- 语义，就是一段内容代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
- 顺序，就是先干啥，后干啥。例如，先加上某个值，再减去某个值。

计算机语言，能够教给一台计算机完成你的工作，但是，要想一大片机器互相协作、共同完成一件事，只教给一台机器做什么是不够的，你需要学会
给一大片机器做什么。这就需要**网络协议**。

## 网络分层的真实含义是什么？
复杂的程序都要分层。比如，复杂的电商还会分数据库层、缓存层、Compose 层、Controller 层和接入层，每一层专注做本层的事情。

程序是如何工作的？
![](../images/network-protocol/protocol-layers.jpg)

只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。

例如：TCP 在三次握手的时候，IP 层和MAC 层在做什么呢？当然是TCP 发送每一个消息，都会带着IP 层和MAC 层了。因为，TCP 每发送一个消息，IP 层和MAC 层的所有机制都
要运行一遍。而你只看到TCP 三次握手了，其实，IP 层和MAC 层为此也忙活好久了。

所以，对TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有IP 层和MAC 层，不然是发不出去的。

所谓的**二层设备、三层设备**，都是这些设备上跑的程序不同而已。一个HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包。这里面HTTP、TCP、IP、MAC 都有。什么叫二层设备呀，
就是只把MAC 头摘下来，看看到底是丢弃、转发，还是自己留着。那什么叫三层设备呢？就是把MAC头摘下来之后，再把IP 头摘下来，看看到底是丢弃、转发，还是自己留着。

## ifconfig：最熟悉又陌生的命令行
怎么查看IP 地址？
Windows 上是`ipconfig`，在Linux 上是`ifconfig`，`ip addr`。

**IP 地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码。**大部分的网卡都会有一个IP 地址，当然，这不是必须的。

32 位的IP 地址就被分成了5 类：

![](../images/network-protocol/ipaddr.jpg)

![](../images/network-protocol/ipaddr-range.jpg)

C 类地址能包含的最大主机数量只有254 个，现在估计一个网吧都不够用。
B 类地址能包含的最大主机数量又太多了。6 万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。

### 无类型域间选路（CIDR）
CIDR，打破了原来设计的几类地址的做法，将`32`位的IP 地址一分为二，前面是网络号，后面是主机号。从哪里分呢？你如果注意观察的话可以看到，`10.100.122.2/24`，
这个IP 地址中有一个斜杠，斜杠后面有个数字`24`。这种地址表示形式，就是CIDR。后面`24`的意思是，`32`位中，前`24`位是网络号，后`8`位是主机号。

伴随着CIDR 存在的，一个是**广播地址**，`10.100.122.255`。如果发送这个地址，所有`10.100.122`网络里面的机器都可以收到。另一个是**子网掩码**，`255.255.255.0`。
将子网掩码和IP 地址进行`AND`计算，就可得到**网络号**。


### 公有IP 地址和私有IP 地址

在日常的工作中，几乎不用划分A 类、B 类或者C 类，所以时间长了，很多人就忘记了这个分类，而只记得CIDR。但是有一点还是要注意的，就是公有IP 地址和私有IP 地址。

![](../images/network-protocol/ipaddr-range.jpg)

表格最右列是私有IP 地址段。平时我们看到的数据中心里，办公室、家里或学校的IP 地址，一般都是私有IP 地址段。因为这些地址允许组织内部的IT 人员自己管理、自己分配，而
且可以重复。因此，你学校的某个私有IP 地址段和我学校的可以是一样的。

这就像每个小区有自己的楼编号和门牌号，你们小区可以叫6 栋，我们小区也叫6 栋，没有任何问题。但是一旦出了小区，就需要使用公有IP 地址。

`192.168.0.x`是最常用的私有IP 地址。一般你家里地上网设备不会超过256 个，所以`/24`基本就够了。有时候我们也能见到`/16 =`的CIDR，这两种是最常见的。
很明显`192.168.0`是网络号，整个网络里面的第一个地址`192.168.0.1`,往往就是你这个**私有网络的出口地址**。例如你家的路由器地址就是`192.168.0.1`。
`192.168.0.255`就是广播地址。一旦发送这个地址，整个`192.168.0`网络里面的所有机器都能收到。

### 一个容易“犯错”的CIDR
`16.158.165.91/22`这个CIDR。求一下这个网络的第一个地址、子网掩码和广播地址。

要是上来就写`16.158.165.1`，那就大错特错了。

`/22`不是`8`的整数倍，不好办，只能先变成二进制来看。`16.158`的部分不会动，它占了前`16`位。中间的`165`，变为二进制为`10100101` 。除了前面的`16`位，
还剩`6`位。所以，这`8`位中前`6`位是网络号，`16.158.<101001>`，而`<01>.91`是机器号。第一个地址是`16.158.<101001><00>.1`，即`16.158.164.1`。
子网掩码是`255.255.<111111><00>.0`，即`255.255.252.0`。广播地址为`16.158.<101001><11>.255`，即`16.158.167.255`。

**D 类是组播地址**。使用这一类地址，属于某个组的机器都能收到。这有点类似在公司里面大家都加入了一个邮件组。发送邮件，加入这个组的都能收到。

```bash
root@test:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
inet6 ::1/128 scope host
valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff
inet 10.100.122.2/24 brd 10.100.122.255 scope global eth0
valid_lft forever preferred_lft forever
inet6 fe80::f816:3eff:fec7:7975/64 scope link
valid_lft forever preferred_lft forever
```

上面的输出，IP 地址的后面有个`scope`，对于`eth0`这张网卡来讲，是`global`，说明这张网卡是可以对外的，可以接收来自各个地方的包。对于`lo`来讲，是`host`，说明这张网
卡仅仅可以供本机相互通信。

`lo`全称是`loopback`，又称环回接口，往往会被分配到`127.0.0.1`这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。这就是为什么你可以在浏览器
通过访问`127.0.0.1`这个地址来访问本地服务，而且一般在你本机的`host`文件，会有`127.0.0.1 localhost`，这是个映射关系，访问`localhost`相当于`127.0.0.1`。


### MAC 地址
`link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff`，这个被称为 **MAC 地址**，网卡的物理地址，用十六进制，6 个byte 表示。

MAC 地址既然全局唯一，不会有两个网卡有相同的 MAC 地址，那么为什么不直接用MAC地址来进行通信？

**一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能。**IP 地址，才是有远程定位功能的。

**MAC 地址更像是身份证，是一个唯一的标识。**它的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不用担心冲突。从硬件角度，保证不同的网卡有不同的标识。

例如，你去杭州市网商路599 号B 楼6 层找刘超，你在路上问路，可能被问的人不知道B 楼是哪个，但是可以给你指网商路怎么去。但是如果你问一个人，你知道这个身份证号的人在哪里吗？可想而知，
没有人知道。

MAC 地址是有一定定位功能的，只不过范围非常有限。你可以根据IP 地址，找到杭州市网商路599 号B 楼6 层，但是依然找不到我，你就可以靠吼了，
大声喊身份证XXXX 的是哪位？我听到了，我就会站起来说，是我啊。

MAC 地址的通信范围比较小，局限在一个子网里面。例如，例如，从`192.168.0.2/24`访问`192.168.0.3/24`是可以用MAC 地址的。一旦跨子网，即从`192.168.0.2/24`到
`192.168.1.2/24`，MAC地址就不行了，需要IP 地址起作用了。

### 网络设备的状态标识
`<BROADCAST,MULTICAST,UP,LOWER_UP>`是干什么的？这个叫作`net_device flags`，**网络设备的状态标识**。
- `UP`表示网卡处于启动的状态
- `BROADCAST`表示这个网卡有广播地址，可以发送广播包
- `MULTICAST`表示网卡可以发送多播包
- `LOWER_UP`表示`L1`是启动的，也即网线插着呢。
- `MTU1500`是指最大传输单元MTU 为1500，这是以太网的默认值。MTU 是二层MAC 层的概念。MAC 层有MAC 的头，以太网规定连MAC 头带正文合起来，不允许超过1500 个字节。
正文里面有IP 的头、TCP 的头、HTTP 的头。如果放不下，就需要分片来传输。

## DHCP：IP是怎么来的，又是怎么没的？
### 如何配置IP 地址
命令行自己配置一个地址。可以使用ifconfig，也可以使用ip addr。设置好了以后，用这两个命令，将网卡up 一下，就可以开始工作了。

但是不能随便配置，例如`192.168.1.6`就在你这台机器的旁边，甚至是在同一个交换机上，而你把机器的地址设为了`16.158.23.6`。在这台机器上，你企图去`ping 192.168.1.6`，
你看着它有自己的源IP 地址`16.158.23.6`，也有目标IP 地址`192.168.1.6`，但是包发不出去，这是因为MAC 层还没填。**IP 只有是一个网段的，它才会发送ARP 请求，获取MAC 地址**。
如果不是，**它便不会直接将包发送到网络上，而是企图将包发送到网关**。

如果你配置了网关的话，Linux 会获取网关的MAC 地址，然后将包发出去。对于`192.168.1.6`这台机器来讲，虽然路过它家门的这个包，目标IP 是它，但是无奈MAC 地址不是它的，
所以它的网卡是不会把包收进去的。如果没有配置网关，那包压根就发不出去。

**网关要和当前的网络至少一个网卡是同一个网段的**，否则不会配置成功。

### 动态主机配置协议（DHCP）
有了这个协议，网络管理员只需要配置一段共享的IP 地址。每一台新接入的机器都通过 DHCP 协议，来这个共享的IP 地址里申请，然后自动配置好就可以了。等人走了，或者用完了，还回
去，这样其他的机器也能用。

**如果是数据中心里面的服务器，IP 一旦配置好，基本不会变，这就相当于买房自己装修。 DHCP 的方式就相当于租房。你不用装修，都是帮你配置好的。你暂时用一下，用完退租就可以了。**

### 解析DHCP 的工作方式
一台机器新加入一个网络的时候，只知道自己的MAC 地址。怎么办？先吼一句，我来啦，有人吗？这时候的沟通基本靠“吼”。这一步，我们称为**DHCP Discover**。

第一步：
新来的机器使用IP 地址0.0.0.0 发送了一个广播包，目的IP 地址为255.255.255.255。
![](../images/network-protocol/dhcp1.jpg)

第二步：
**DHCP Server**立刻能知道来了一个“新人”，这个时候，我们可以体会MAC 地址唯一的重要性了。当一台机器带着自己的MAC地址加入一个网络的时候，MAC 是它唯一的身份，
如果连这个都重复了，就没办法配置了。**只有MAC 唯一，IP 管理员才能知道这是一个新人**。租给它一个IP 地址，这个过程我们称为**DHCP Offer**。同时，DHCP Server 为
此客户**保留为它提供的IP 地址**，从而不会为其他DHCP 客户分配此IP地址。**DHCP Offer 里面有新的分配的地址**：
![](../images/network-protocol/dhcp2.jpg)

DHCP Server 仍然使用广播地址作为目的地址，因为，此时请求分配IP 的新人还没有自己的IP。

第三步：
如果有多个DHCP Server，这台新机器会收到多个IP 地址，选择其中一个DHCP Offer，**一般是最先到达的那个**。并且会向网络发送一个DHCP Request 广播数据包，包中包含客户端
的MAC 地址、接受的租约中的IP 地址、提供此租约的DHCP 服务器地址等，并告诉所有DHCP Server 它将接受哪一台服务器提供的IP 地址，告诉其他DHCP 服务器请求撤销它们提供的IP 地址，
以便提供给下一个IP 租用请求者。
![](../images/network-protocol/dhcp3.jpg)

由于还没有得到DHCP Server 的最后确认，客户端仍然使用`0.0.0.0`为源IP 地址、`255.255.255.255`为目标地址进行广播。

第四步：
DHCP Server 接收到客户机的DHCP request 之后，会广播返回给客户机一个DHCP ACK 消息包，表明已经接受客户机的选择，并将这一IP 地址的合法租用信息和其他的配置信息都放入该
广播包，发给客户机，欢迎它加入网络大家庭。

![](../images/network-protocol/dhcp4.jpg)


### IP 地址的收回和续租
客户机会在租期过去50% 的时候，直接向为其提供IP 地址的DHCP Server 发送DHCP request 消息包。客户机接收到该服务器回应的DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新
的TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

## 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？

### 第一层（物理层）
宿舍两个人的电脑怎么连接起来？可以使用路由器，但是路由器是在第三层上。我们先从第一层物理层开始说。

电脑连电脑。这种方式就是一根网线，有两个头。一头插在一台电脑的网卡上，另一头插在另一台电脑的网卡上。还需要配置这两台电脑的IP 地址、子网掩码和默认网关。
要想两台电脑能够通信，这三项必须配置成为一个网络，可以一个是`192.168.0.1/24`，另一个是`192.168.0.2/24`，否则是不通的。构成了一个最小的局域网，也即**LAN**。

两台电脑之间的网络包，包含MAC 层吗？当然包含，要完整。IP 层要封装了MAC 层才能将包放入物理层。

怎么把三台电脑连在一起呢？
有一个叫作Hub的东西，也就是集线器。这种设备有多个口，可以将宿舍里的多台电脑连接起来。但是，和交换机不同，集线器没有大脑，它完全在物理层工作。它会将自
己收到的每一个字节，都复制到其他端口上去。这是第一层物理层联通的方案。

### 第二层（数据链路层）

Hub 采取的是广播的模式，如果每一台电脑发出的包，宿舍的每个电脑都能收到。这就需要解决几个问题：
1. 这个包是发给谁的？谁应该接收？
2. 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？
3. 如果发送的时候出现了错误，怎么办？

这几个问题都是第二层，数据链路层，也即 MAC 层要解决的问题。**MAC的全称是Medium Access Control，即媒体访问控制**。

第二个问题，有很多算法可以解决：

- 方式一：分多个车道。每个车一个车道，你走你的，我走我的。这在计算机网络里叫作**信道划分**；
- 方式二：今天单号出行，明天双号出行，轮着来。这在计算机网络里叫作**轮流协议**；
- 方式三：不管三七二十一，有事儿先出门，发现特堵，就回去。错过高峰再出。我们叫作**随机接入协议**。著名的以太网，用的就是这个方式。

解决了第二个问题，就是解决了媒体接入控制的问题。

第一个问题：这里用到链路层地址，也被称为**MAC 地址**。

第二层的网络包格式：
![](../images/network-protocol/macpack.jpg)

有了这个目标MAC 地址，数据包在链路上广播，MAC 的网卡才能发现，这个包是给它的。MAC 的网卡把包收进来，然后打开IP 包，发现IP 地址也是自己的，再打开TCP 包，发现端口是自己，也就是
80，而nginx 就是监听80。

于是将请求提交给nginx，nginx 返回一个网页。然后将网页需要发回请求的机器。然后层层封装，最后到MAC 层。因为来的时候有源MAC 地址，返回的时候，源MAC 就变成了目标MAC，再返给请求
的机器。

第三个问题：**CRC**，也就是**循环冗余检测**。通过XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误。

### ARP 协议

当源机器知道目标机器的时候，可以将目标地址放入包里面，如果不知道呢？一个广播的网络里面接入了N 台机器，我怎么知道每个MAC 地址是谁呢？这就是**ARP 协议**，也
就是已知IP 地址，求MAC 地址的协议。

在一个局域网里面，当知道了IP 地址，不知道MAC 怎么办呢？靠“吼”。

![](../images/network-protocol/arp.jpg)

为了避免每次都用ARP 请求，机器本地也会进行ARP 缓存。当然机器会不断地上线下线，IP 也可能会变，所以ARP 的MAC 地址缓存过一段时间就会过期。

### 局域网
Hub 组网的方式，一旦机器数目增多，问题就出现了。因为Hub 是广播的，不管某个接口是否需要，所有的Bit 都会被发送出去，然后让主机来判断是不是需要。这种方式路
上的车少就没问题，车一多，产生冲突的概率就提高了。而且把不需要的包转发过去，纯属浪费。

这就需要二层设备，**交换机**。

因为每个口都只连接一台电脑，这台电脑又不怎么换IP 和MAC 地址，只要记住这台电脑的MAC 地址，如果目标MAC 地址不是这台电脑的，这个口就不用转发了。
交换机怎么知道每个口的电脑的MAC 地址呢？这需要交换机会学习。

一台MAC1 电脑将一个包发送给另一台MAC2 电脑，当这个包到达交换机的时候，一开始交换机也不知道MAC2 的电脑在哪个口，所以没办法，它只能将包转发给出了来的那个口之外的其他所有的口。
这个时候，交换机会记住 MAC1 是来自一个明确的口。以后有包的目的地址是MAC1 的，直接发送到这个口就可以了。

交换机作为一个关卡一样，过了一段时间之后，就有了整个网络的一个结构了，这个时候，基本上不用广播了，全部可以准确转发。当然，每个机器的IP 地址会变，所在的口也会变，因而交换机上的学习
的结果，我们称为**转发表**，是有一个过期时间的。

## 交换机与VLAN：办公室太复杂，我要回学校

### 拓扑结构是怎么形成的



